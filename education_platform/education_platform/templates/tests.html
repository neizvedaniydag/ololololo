{% extends "base.html" %}
{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tests.css') }}">
{% endblock %}

{% block content %}
<div class="tests-container">
    <h1>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤</h1>
    <p style="color: var(--text-light); margin-bottom: 2rem;">
        –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é —Ç–µ–º—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª
    </p>

    <!-- –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ -->
    <div class="subject-selector">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</h2>
        <div class="subjects-grid" id="subjectsGrid">
            <!-- –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ JSON -->
        </div>
    </div>

    <!-- –¢–µ–º—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É -->
    <div id="topicsBlock" style="display: none;">
        <div class="topics-header">
            <h2>
                <span id="selectedSubjectIcon"></span>
                <span id="selectedSubjectName"></span>
            </h2>
            <button class="btn btn-secondary btn-sm" onclick="backToSubjects()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <div class="topics-grid" id="topicsGrid"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª -->
        <div class="custom-topic-btn-wrapper">
            <button class="btn-custom-topic" onclick="openCustomModal()">
                <span style="font-size: 2rem;">‚ûï</span>
                <span style="font-weight: 700; font-size: 1.2rem;">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª</span>
                <span style="color: #fff; opacity: 0.9; font-size: 0.95rem;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞</span>
            </button>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ -->
    <div class="tests-history">
        <h2>–ú–æ–∏ —Ç–µ—Å—Ç—ã</h2>

        {% if tests %}
        <div class="tests-list">
            {% for test in tests %}
            <div class="test-card">
                <div class="test-info">
                    <h3>{{ test.subject }}</h3>
                    <p>{{ test.topic }}</p>
                    <span class="test-date">{{ test.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
                <div class="test-actions">
                    <a href="{{ url_for('take_test', test_id=test.id) }}" class="btn btn-primary">
                        –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
                    </a>
                    <button onclick="deleteTest({{ test.id }})" class="btn btn-danger">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: var(--text-light); padding: 2rem;">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
        </p>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–µ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
<div id="customModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h2>
            <button class="modal-close" onclick="closeCustomModal()">√ó</button>
        </div>

        <form id="customTestForm">
            <div class="form-group">
                <label>–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                <textarea id="customText" name="custom_text"
                          placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç –ª–µ–∫—Ü–∏–∏, –ø–∞—Ä–∞–≥—Ä–∞—Ñ —É—á–µ–±–Ω–∏–∫–∞ –∏–ª–∏ –ª—é–±–æ–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª...

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ –ö–æ–Ω—Å–ø–µ–∫—Ç —É—Ä–æ–∫–∞
‚Ä¢ –ü–∞—Ä–∞–≥—Ä–∞—Ñ –∏–∑ —É—á–µ–±–Ω–∏–∫–∞
‚Ä¢ –°—Ç–∞—Ç—å—è –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏
‚Ä¢ –ù–∞—É—á–Ω–∞—è —Å—Ç–∞—Ç—å—è
‚Ä¢ –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª

–ú–∏–Ω–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞."
                          rows="15" required></textarea>
                <div class="char-counter">
                    <span id="charCount">0</span> —Å–∏–º–≤–æ–ª–æ–≤ (–º–∏–Ω–∏–º—É–º 200)
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤</label>
                    <select id="custom_num_questions" name="num_questions">
                        <option value="5">5 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                        <option value="10" selected>10 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                        <option value="15">15 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                        <option value="20">20 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                    </select>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCustomModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="btn btn-primary btn-large">
                    <span class="btn-icon">ü§ñ</span>
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ—Å—Ç–∞ -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="topicModalTitle"></h2>
            <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
        </div>

        <form id="standardTestForm">
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤</label>
                <select id="num_questions" name="num_questions">
                    <option value="5">5 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                    <option value="10" selected>10 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                    <option value="15">15 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                    <option value="20">20 –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                </select>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="btn btn-primary btn-large">
                    <span class="btn-icon">‚ú®</span>
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingModal" class="modal-loading" style="display: none;">
    <div class="loading-content">
        <div class="spinner-large"></div>
        <h3>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞...</h3>
        <p>AI —Å–æ–∑–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è</p>
    </div>
</div>

<script>
// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—ã –∏ –∏–∫–æ–Ω–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
let TOPICS = {};
let ICONS = {};
let currentSubject = '';
let currentSubjectIcon = '';
let selectedTopic = '';

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
fetch('/api/subjects-topics')
    .then(response => response.json())
    .then(data => {
        Object.keys(data).forEach(subject => {
            TOPICS[subject] = data[subject].topics;
            ICONS[subject] = data[subject].icon;
        });

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        renderSubjects();
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º:', error);
    });

function renderSubjects() {
    const grid = document.getElementById('subjectsGrid');
    grid.innerHTML = '';

    Object.keys(TOPICS).forEach(subject => {
        const btn = document.createElement('button');
        btn.className = 'subject-btn';
        btn.innerHTML = `
            <span class="subject-icon">${ICONS[subject]}</span>
            <span>${subject}</span>
        `;
        btn.onclick = () => selectSubject(subject);
        grid.appendChild(btn);
    });
}

function selectSubject(subject) {
    currentSubject = subject;
    currentSubjectIcon = ICONS[subject];

    document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.subject-btn').classList.add('active');

    document.getElementById('selectedSubjectIcon').textContent = currentSubjectIcon;
    document.getElementById('selectedSubjectName').textContent = subject;

    const topicsGrid = document.getElementById('topicsGrid');
    topicsGrid.innerHTML = '';

    TOPICS[subject].forEach(topic => {
        const btn = document.createElement('button');
        btn.className = 'topic-btn';
        btn.textContent = topic;
        btn.onclick = () => selectTopic(topic);
        topicsGrid.appendChild(btn);
    });

    document.getElementById('topicsBlock').style.display = 'block';
    document.getElementById('topicsBlock').scrollIntoView({ behavior: 'smooth' });
}

function backToSubjects() {
    document.getElementById('topicsBlock').style.display = 'none';
    document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('active'));
}

function selectTopic(topic) {
    selectedTopic = topic;
    document.getElementById('topicModalTitle').textContent = currentSubjectIcon + ' ' + topic;
    document.getElementById('settingsModal').classList.add('active');
}

function closeSettingsModal() {
    document.getElementById('settingsModal').classList.remove('active');
}

function openCustomModal() {
    document.getElementById('customModal').classList.add('active');
}

function closeCustomModal() {
    document.getElementById('customModal').classList.remove('active');
    document.getElementById('customText').value = '';
    document.getElementById('charCount').textContent = '0';
}

// –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
const customText = document.getElementById('customText');
const charCount = document.getElementById('charCount');

customText.addEventListener('input', function() {
    const count = this.value.length;
    charCount.textContent = count;
    charCount.style.color = count >= 200 ? '#4caf50' : '#ef5350';
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã
document.getElementById('standardTestForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    closeSettingsModal();

    const formData = {
        subject: currentSubject,
        topic: selectedTopic,
        num_questions: parseInt(document.getElementById('num_questions').value)
    };

    await generateTest(formData);
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ñ–æ—Ä–º—ã
document.getElementById('customTestForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const text = document.getElementById('customText').value;

    if (text.length < 200) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞');
        return;
    }

    closeCustomModal();

    const formData = {
        custom_text: text,
        num_questions: parseInt(document.getElementById('custom_num_questions').value)
    };

    await generateTest(formData);
});

async function generateTest(data) {
    document.getElementById('loadingModal').style.display = 'flex';

    try {
        const response = await fetch('/api/generate-test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = `/test/${result.test_id}`;
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞: ' + error.message);
    } finally {
        document.getElementById('loadingModal').style.display = 'none';
    }
}

async function deleteTest(testId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç?')) {
        return;
    }

    try {
        const response = await fetch(`/api/test/${testId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞');
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}
</script>
{% endblock %}
